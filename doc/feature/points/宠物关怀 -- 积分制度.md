## 背景介绍

### 1.1 业务背景

目前宠物关怀项目没有任何变现能力，本身不期望通过买断、订阅的方式直接收取费用。目前的考虑是通过积分制来做前期引流，积分作为宠物关怀的通用货币。后期再通过比如积分充值的形式来获取服务调用额度，或者一些赠品兑换。

### 1.2 设计原则

- **低门槛参与**：新用户快速获取初始积分
- **公平透明**：积分规则清晰可见，变动可追溯
- **渐进式激励**：随着等级提升获得更多权益
- **生态闭环**：积分获取与消耗形成良性循环

### 1.3 MVP 范围

| 模块 | 范围 |
| --- | --- |
| 积分获取 | 签到、发布内容、评论、点赞 |
| 积分消耗 | AI健康咨询 |
| 代金券 | 基础发放和使用 |
| 等级体系 | 根据累计积分实时计算展示 |

---

## 功能模块

### 2.1 积分账户

每个用户拥有一个积分账户，包含：
- **可用积分**：当前可消费的积分余额，获取时增加，消耗时减少
- **累计积分**：历史获取积分总和，只增不减，用于等级计算

**初始积分**：新用户注册即赠送 1000 积分

### 2.2 积分获取

#### 基础行为积分

| 行为类型 | 积分值 | 每日上限 | 说明 |
| --- | --- | --- | --- |
| 每日签到 | 10 | 1次 | 每日固定积分 |
| 完善宠物档案 | 50 | 无 | 上传照片+10，填写健康信息+20等 |
| 发布内容（图文/视频） | 30 | 5次 | 需审核通过，低质量内容不计分 |
| 发布评论 | 5 | 20次 | 需超过10字，有意义内容 |
| 点赞他人内容 | 2 | 50次 | 防刷机制：同一用户限5次/天 |

#### 内容质量积分

| 质量指标 | 积分奖励 | 说明 |
| --- | --- | --- |
| 内容被点赞 | 1/次 | 每内容每日上限50积分 |
| 内容被评论 | 3/次 | 每内容每日上限100积分 |
| 内容被官方精选 | 200 | 额外一次性奖励 |
| 内容进入热门榜 | 100 | 每日根据算法排名 |

#### 社交传播积分

| 行为 | 积分奖励 | 说明 |
| --- | --- | --- |
| 邀请新用户注册 | 200 | 新用户完成基础资料 |
| 分享内容至外部 | 10 | 需产生有效点击（防刷） |
| 参与官方活动 | 50-500 | 根据活动级别调整 |

### 2.3 积分消耗

#### 功能使用消耗

| 功能 | 积分消耗 | 说明 |
| --- | --- | --- |
| AI健康咨询 | 10/次或1/100Token | 基础问题免费，深度咨询收费 |
| 内容置顶 | 100/天 | 在所属圈子内置顶24小时 |
| 内容加精 | 500 | 获得官方加精标识，提升曝光 |
| 查看高级健康报告 | 50/次 | 更详细的健康数据分析 |

#### 权益兑换消耗

| 权益类型 | 积分消耗 | 说明 |
| --- | --- | --- |
| 实物兑换 | 1000-10000 | 宠物玩具、零食等（需合作商家） |
| 优惠券兑换 | 500-5000 | 合作商家优惠券（CPS分成） |
| 虚拟权益 | 100-1000 | 专属头像框、聊天气泡等 |
| 抽奖机会 | 200/次 | 积分抽奖，奖品池动态调整 |

#### 服务增值消耗

| 服务 | 积分消耗 | 说明 |
| --- | --- | --- |
| 优先客服 | 300 | 跳过排队，优先接入人工客服 |
| 活动优先参与权 | 200 | 热门活动提前报名资格 |
| 定制化提醒模板 | 100 | 个性化提醒模板设计 |

### 2.4 积分代金券

系统/活动发放的积分抵扣券，消费时可抵扣积分。

#### 券属性

| 属性 | 说明 |
| --- | --- |
| 面值 | 可抵扣的积分数量 |
| 有效期 | 领取后N天内有效 |
| 来源类型 | 系统发放、活动发放、新人礼包等 |
| 领取限制 | 每人限领数量 |

#### 使用规则

- 消费时可选择使用代金券抵扣积分
- 一次消费仅支持使用一张券
- 抵扣金额不超过实际消耗积分
- 过期自动失效，不可找回

### 2.5 等级体系

等级根据累计积分实时计算，不单独存储。

#### 等级划分

| 等级 | 所需总积分 | 等级称号 | 权益 |
| --- | --- | --- | --- |
| Lv1 | 0-99 | 萌新铲屎官 | 基础功能 |
| Lv2 | 100-499 | 入门铲屎官 | 每日积分上限+50 |
| Lv3 | 500-1499 | 熟练铲屎官 | 内容曝光权重+10% |
| Lv4 | 1500-3499 | 资深铲屎官 | 专属标识，积分获取+10% |
| Lv5 | 3500-6999 | 专家铲屎官 | AI咨询8折，优先客服 |
| Lv6 | 7000-14999 | 宠物达人 | 内容曝光权重+25% |
| Lv7 | 15000-29999 | 圈内红人 | 官方活动优先参与权 |
| Lv8 | 30000-59999 | 宠物大师 | 受邀参与产品内测 |
| Lv9 | 60000-119999 | 社区领袖 | 专属客服通道 |
| Lv10 | 120000+ | 宠物宗师 | 所有权益最大化，定制化服务 |

#### 等级权益机制

- **曝光权重加成**：高等级用户发布内容在推荐流中获得更高权重
- **积分获取加成**：高等级用户获取积分时有百分比加成
- **专属身份标识**：在社区中显示特殊徽章和称号
- **功能特权**：部分高级功能仅对高等级用户开放

---

## 技术方案

### 3.1 数据模型

| 表名 | 用途 |
| --- | --- |
| `user_points_account` | 用户积分账户，存储可用积分和累计积分 |
| `user_points_record` | 积分流水记录，记录每笔变动明细 |
| `points_coupon_template` | 代金券模板，定义券的属性规则 |
| `user_points_coupon` | 用户代金券实例，记录领取和使用状态 |

### 3.2 Redis 缓存

#### 主动行为缓存（每日次数限制）

**Key**：`core:user:action:{userId}:{date}`

**类型**：Hash

**过期策略**：当日过期

| Field | 用途 |
| --- | --- |
| `checkin` | 签到状态（1已签到） |
| `publish` | 发布内容次数 |
| `comment` | 评论次数 |
| `like` | 点赞次数 |

#### 质量行为缓存（用户去重）

**Key**：`core:content:like:{contentId}:{date}` / `core:content:comment:{contentId}:{date}`

**类型**：Set

**Members**：userId

**过期策略**：当日过期

**用途**：记录每日互动过的用户，防止同一用户重复计分

**示例**：
```
# 用户A点赞了内容123
SADD core:content:like:123:20250206 "A"
# 返回1表示首次点赞，返回0表示重复

# 用户B评论了内容123
SADD core:content:comment:123:20250206 "B"
```

### 3.3 行为类型枚举（MVP）

| 枚举值 | 名称 | 积分变动 | 说明 |
| --- | --- | --- | --- |
| 0 | 注册赠送 | +10000 | 新用户注册时一次性发放 |
| 1 | 签到 | +10 | 每日签到，每日上限1次 |
| 2 | 发布内容 | +30 | 发布图文/视频，每日上限5次 |
| 3 | 发布评论 | +5 | 发布评论，每日上限20次 |
| 4 | 点赞他人 | +2 | 点赞他人内容，每日上限50次 |
| 5 | 被点赞 | +1 | 内容被他人点赞，每人每日只计1次 |
| 6 | 被评论 | +3 | 内容被他人评论，每人每日只计1次 |
| 7 | AI健康咨询 | -10 | AI咨询消耗积分 |

### 3.4 并发与事务

| 方案 | 说明 |
| --- | --- |
| 并发控制 | Redisson 分布式锁，锁粒度为用户级别 |
| 事务方案 | 本地事务（@Transactional） |

> 后续优化：考虑引入消息队列解耦积分写入，提高接口响应性能

### 3.5 核心流程

#### 主动行为积分获取流程

1. 校验行为有效性（防刷、质量审核）
2. 查询 Redis 当日行为计数，校验是否超限
3. 获取用户分布式锁
4. 更新积分账户（可用积分+、累计积分+）
5. 写入积分流水
6. Redis 行为计数+1
7. 释放锁

#### 质量行为积分获取流程（被点赞/被评论）

1. 校验互动有效性
2. 使用 Set 去重：`SADD core:content:like:{contentId}:{date} {userId}`
3. 如果返回 1（首次互动）：
   - 获取内容作者分布式锁
   - 更新作者积分账户（可用积分+、累计积分+）
   - 写入积分流水
   - 释放锁

#### 积分消耗流程

1. 校验可用积分是否充足
2. 若使用代金券，校验券状态和有效期
3. 获取用户分布式锁
4. 扣减可用积分（累计积分不变）
5. 写入积分流水（记录券抵扣信息）
6. 若使用券，更新券状态为已使用
7. 释放锁

#### 新用户注册流程

1. 创建用户积分账户记录（available_points=10000, total_points=10000）
2. 写入注册赠送流水（action_type=0, points=+10000）
