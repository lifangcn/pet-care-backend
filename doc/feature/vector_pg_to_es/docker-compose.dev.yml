services:
  # 1. 反向代理：Nginx (Alpine)
  nginx:
    image: nginx:alpine
    container_name: dev-petcare-nginx
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/logs:/var/log/nginx
      - /Users/michael/VueProjects/pet-care-vue/dist:/usr/share/nginx/html # 指定项目静态页面打包路径
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    networks:
      - petcare-network
    # Linux Docker 环境：添加 host.docker.internal 支持（映射到 Docker 网关）
    extra_hosts:
      - "host.docker.internal:host-gateway"
  # 2. 数据库：MySQL 5.7.40
  mysql:
    image: mysql:5.7.40
    container_name: dev-petcare-mysql
    environment:
      TZ: Asia/Shanghai    #时区
      LANG: en_US.UTF-8    #语言编码
      MYSQL_ROOT_PASSWORD: "!QAZ2wsx"
      MYSQL_DATABASE: mysql
      MYSQL_USER: petcareadmin
      MYSQL_PASSWORD: "!QAZ2wsx"
    volumes:
      - ./mysql/my.cnf:/etc/mysql/my.cnf
      - ./mysql/data:/var/lib/mysql
      - ./mysql/init-scripts:/docker-entrypoint-initdb.d/ # 初始化数据库脚本
      - ./mysql/tmp:/var/tmp # 挂载临时文件, 如需要导入dump，可进入容器，登录 MySQL，再使用 source /var/tmp/dump.sql导入
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - petcare-network

  # 3. 缓存：Redis 6.2 Alpine
  redis:
    image: redis:6.2-alpine
    container_name: dev-petcare-redis
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
      - ./redis/data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - petcare-network
  # 4.rocketmq:5.3.2 - namesrv
  rmqnamesrv:
    image: apache/rocketmq:5.3.2
    container_name: dev-petcare-rmq-namesrv
    ports:
      - 9876:9876
    command: sh mqnamesrv
    environment:
      - "JAVA_OPT_EXT=-Xms256M -Xmx256M"
    networks:
      - petcare-network
  # 4.rocketmq:5.3.2 - broker
  rmqbroker:
    image: apache/rocketmq:5.3.2
    container_name: dev-petcare-rmq-broker
    ports:
      - 10909:10909
      - 10911:10911
      - 10912:10912
    environment:
      - "JAVA_OPT_EXT=-server -Xms512m -Xmx512m"
      - "NAMESRV_ADDR=rmqnamesrv:9876"
    volumes:
      - ./rocketmq/broker.conf:/home/rocketmq/rocketmq-5.3.2/conf/broker.conf
    depends_on:
      - rmqnamesrv
    networks:
      - petcare-network
    command: sh mqbroker -c /home/rocketmq/rocketmq-5.3.2/conf/broker.conf
  # 4.rocketmq-dashboard:latest - dashboard
  rmqdashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: dev-petcare-rmq-dashboard
    ports:
      - 18082:8082
    environment:
      - JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Xms256m -Xmx256m
    volumes:
      - ./rocketmq/dashboard/tmp:/tmp
    depends_on:
      - rmqnamesrv
    networks:
      - petcare-network

  # 5. 数据库：PostgreSQL 16.11
  pgvector:
    image: pgvector/pgvector:0.8.0-pg16
    container_name: dev-petcare-pgvector
    environment:
      POSTGRES_DB: pet_care_ai_vector
      POSTGRES_USER: postgres_root
      POSTGRES_PASSWORD: "!QAZ2wsx"
      # volumes:
      #   # 挂载数据卷以持久化数据
      #   - ./pgvector/data:/var/lib/postgresql/data/pgdata:ro
      # 可选：挂载初始化脚本目录
      # - ./pgvector/init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - petcare-network

  # 6. 搜索引擎：Elasticsearch 8.17.0
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: dev-petcare-es
    privileged: true
    environment:
      #  重要：不实用SSL加密
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      # 开启 knn 向量检索增强插件
      - xpack.ml.enabled=true
      # 设置集群名称
      - cluster.name=elasticsearch
      # 设置节点名称
      - node.name=es01
      # 启用单节点发现模式（开发环境使用）
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      # 挂载数据目录，持久化存储ES数据
      - ./elasticsearch/data:/usr/share/elasticsearch/data
      - ./elasticsearch/plugins:/var/tmp
      # 挂载本地zip安装包到/var/tmp路径下，避免生成.DS_Store文件导致启动失败
      # 安装需要确认操作，进入容器执行本地安装命令 /usr/share/elasticsearch/bin/elasticsearch-plugin install file:///var/tmp/elasticsearch-analysis-ik-8.17.0.zip
    ports:
      - "9200:9200"
      - "9300:9300"
    restart: unless-stopped
    networks:
      - petcare-network
  # 6. 可视化：kibana 8.17.0
  kibana:
    image: docker.elastic.co/kibana/kibana:8.17.0
    container_name: dev-petcare-kibana
    environment:
      # 设置Elasticsearch实例地址
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana
      - ELASTICSEARCH_PASSWORD=kibana
    ports:
      - "5601:5601"
    restart: unless-stopped
    depends_on:
      - elasticsearch
    networks:
      - petcare-network
  # 7. CDC（Change Data Capture，变更数据捕获）
  canal-server:
    image: canal/canal-server:v1.1.6
    container_name: dev-petcare-canal
    ports:
      - "11111:11111"   # TCP 客户端连接端口
      - "11112:11112"   # 管理端口
    environment:
      # Instance 配置：core 对应 conf/core/instance.properties
      - canal.auto.scan=false                  # 关闭自动扫描，手动指定 destinations
      - canal.destinations=petcare             # Instance 名称，对应 conf/core/ 目录
      # MySQL 连接配置（覆盖 instance.properties，可选）
      - canal.instance.master.address=mysql:3306
      - canal.instance.dbUsername=canal
      - canal.instance.dbPassword=canal
      - canal.mq.servers=rmqnamesrv:9876
    volumes:
      - ./canal/conf/canal.properties:/home/admin/canal-server/conf/canal.properties
      - ./canal/conf/petcare:/home/admin/canal-server/conf/petcare
      - ./canal/data:/home/admin/canal-server/data
    restart: unless-stopped
    depends_on:
      - mysql
      - rmqnamesrv
    networks:
      - petcare-network


networks:
  petcare-network:
    driver: bridge