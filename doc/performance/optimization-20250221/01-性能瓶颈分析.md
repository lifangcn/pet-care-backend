# 积分系统性能瓶颈分析

创建时间: 2025-02-21
作者: Michael Li

---

## 一、核心瓶颈

### 1. Kafka 同步阻塞

**位置**: `PointsServiceImpl:268`

```java
kafkaTemplate.send(CORE_POINTS_RECORD_SAVE_TOPIC, key, value).get();
```

**问题分析**:
- `.get()` 阻塞等待 Kafka broker 确认
- 每次积分变更额外增加 5-50ms 网络延迟
- Kafka 不可用时会导致接口失败

**影响范围**: 所有积分变更接口
- `consume()` - 消耗积分
- `earnByAction()` - 行为获取积分
- `earnByCoupon()` - 券兑换获取积分
- `earnByQuality()` - 质量行为获取积分

**预期优化收益**: 响应时间 -20ms，错误率降低

---

### 2. 锁内冗余数据库查询

#### 问题 2.1: 锁内查询券表

**位置**: `PointsServiceImpl:144`

```java
PointsRecord pointsRecord = transactionTemplate.execute(status ->
    redissonLockUtil.executeWithLock(CORE_POINTS_LOCK_KEY_PREFIX + userId, () -> {
        // 锁内查询 - 增加锁持有时间
        PointsCoupon coupon = pointsCouponMapper.selectOneById(couponId);
        ...
    }, 1, 10));
```

**问题分析**:
- 在分布式锁持有期间执行数据库查询
- 锁等待 3s，持有 10s
- 查询耗时 10-50ms，浪费锁资源

#### 问题 2.2: 更新后立即再查

**位置**: `PointsServiceImpl:236`

```java
// 数据库原子更新
boolean updated = UpdateChain.of(PointsAccount.class)
    .set(POINTS_ACCOUNT.AVAILABLE_POINTS, ...)
    .where(...).update();

// 立即再查一次数据库
PointsAccount accountAfter = getOne(QueryWrapper.create()
    .where(POINTS_ACCOUNT.USER_ID.eq(request.getUserId())));
```

**问题分析**:
- 更新后立即查询获取新余额
- 实际可以通过计算得出
- 额外增加一次数据库交互

**预期优化收益**: 减少锁持有时间 30-50%

---

### 3. 分布式锁串行化

**锁配置**: 等待 3s，持有 10s

**问题场景**:
- 同一用户的并发积分操作完全串行
- 高频场景：点赞、评论、签到等

**影响**:
- 单用户 QPS 受限于锁持有时间
- 理论上限：1s / 10ms = 100 QPS（单用户）

**实际数据**（来自历史压测）:
| 场景 | QPS | 平均响应时间 |
|------|-----|-------------|
| 单用户 500 并发 | 82 | 4898ms |
| 多用户 500 并发 | 175 | 1012ms |

**结论**: 分布式锁是单用户场景的主要瓶颈

---

### 4. Redis 重复访问

#### 问题 4.1: 双重计数检查

**位置**: `PointsServiceImpl:94,102`

```java
// 第一次检查
int count = pointsCacheService.getActionCount(userId, action);
if (count >= limit) {
    return 0;
}

// 第二次检查（防止并发）
int currentCount = pointsCacheService.getActionCount(userId, action);
if (currentCount >= limit) {
    return 0;
}
```

**问题分析**:
- 同一 key 读取两次
- 双倍 Redis 网络开销

#### 问题 4.2: Set 过期设置

**位置**: `PointsCacheServiceImpl:54`

```java
public boolean checkAndAddInteraction(Long contentId, Long userId, ActionTypeOfPointsRecord action) {
    RSet<String> set = redissonClient.getSet(key);
    // 每次 add 都调用 expire
    set.expire(getEndOfToday());
    return set.add(userId.toString());
}
```

**问题分析**:
- 每次 `add()` 都调用 `expire()`
- 可以在首次创建时设置过期时间

**预期优化收益**: Redis QPS +20%

---

### 5. 账户查询冗余

**位置**: `PointsServiceImpl:314`

```java
private PointsAccount getOrCreateAccount(Long userId) {
    // 每次都查询数据库
    PointsAccount account = getOne(QueryWrapper.create()
        .where(POINTS_ACCOUNT.USER_ID.eq(userId)));
    if (account == null) {
        account = new PointsAccount();
        ...
        save(account);
    }
    return account;
}
```

**问题分析**:
- 用户积分账户变更频率低
- 每次操作都查数据库
- 无缓存机制

**预期优化收益**: DB QPS -30%

---

## 二、已优化点（保留）

### 1. 数据库原子更新

**位置**: `PointsServiceImpl:221`

```java
boolean updated = UpdateChain.of(PointsAccount.class)
    .set(POINTS_ACCOUNT.AVAILABLE_POINTS,
        POINTS_ACCOUNT.AVAILABLE_POINTS.subtract(pointsToConsume))
    .where(POINTS_ACCOUNT.USER_ID.eq(userId))
    .and(POINTS_ACCOUNT.AVAILABLE_POINTS.ge(pointsToConsume))
    .update();
```

**优势**: 数据库层面原子性，避免并发丢失更新

---

### 2. Kafka 异步保存流水

**位置**: `PointsRecordSaveConsumer`

**优势**:
- 流水保存不阻塞主流程
- 解耦积分变更与流水记录

---

## 三、瓶颈优先级排序

| 优先级 | 瓶颈点 | 预计收益 | 实现难度 |
|--------|--------|----------|----------|
| **P0** | Kafka 同步阻塞 | 响应 -20ms | 低 |
| **P0** | 锁内查询券表 | 锁时间 -40% | 低 |
| **P1** | 更新后冗余查询 | DB QPS -50% | 低 |
| **P1** | Redis 双重检查 | Redis QPS -30% | 低 |
| **P2** | Set 重复过期 | Redis QPS -10% | 低 |
| **P2** | 账户无缓存 | DB QPS -30% | 中 |

---

## 四、代码位置索引

| 文件 | 行号 | 说明 |
|------|------|------|
| `PointsServiceImpl.java` | 268 | Kafka 同步发送 |
| `PointsServiceImpl.java` | 144 | 锁内查券 |
| `PointsServiceImpl.java` | 236 | 更新后查询 |
| `PointsServiceImpl.java` | 94,102 | 双重计数检查 |
| `PointsServiceImpl.java` | 314 | 账户查询 |
| `PointsCacheServiceImpl.java` | 54 | Set 过期设置 |

---

## 五、监控指标建议

### 关键指标

```java
// 建议添加的监控
1. Kafka 发送耗时 (P50/P95/P99)
2. 分布式锁等待次数
3. 分布式锁等待超时次数
4. 数据库查询耗时
5. Redis 命中率
```

### 告警阈值

| 指标 | 阈值 | 级别 |
|------|------|------|
| Kafka 发送 P99 | > 100ms | Warning |
| 锁等待超时 | > 10/min | Critical |
| DB 查询 P99 | > 50ms | Warning |
