# 移除 Gateway 重构方案
**{@code @description}** 使用 Nginx 替代 Spring Cloud Gateway 的改造方案
**{@code @date}** 2026-01-24
**{@code @author}** Michael

> **注意**：当前 nginx 版本未编译 `auth_request` 模块，JWT 认证由后端服务拦截器处理。

## 一、现状分析

### 1.1 Gateway 模块结构

```
pet-care-gateway/
├── src/main/java/pvt/mktech/petcare/gateway/
│   ├── GatewayApplication.java              # 启动类
│   ├── config/
│   │   └── CacheConfig.java                 # Caffeine 缓存配置
│   ├── filter/
│   │   ├── JwtAuthGatewayFilterFactory.java # JWT 认证过滤器
│   │   ├── SseGatewayFilterFactory.java     # SSE 流式响应过滤器
│   │   └── RateLimitGatewayFilterFactory.java # 限流过滤器
│   ├── util/
│   │   └── RateLimiterUtil.java             # Redisson 限流工具
│   └── handler/
│       └── GlobalExceptionWebExceptionHandler.java
├── src/main/resources/
│   ├── application-local.yml
│   ├── application-prod.yml
│   └── application.yml
└── pom.xml
```

### 1.2 核心功能

| 功能 | 实现方式 | 替代方案 |
|------|----------|----------|
| 路由转发 | Gateway Routes | nginx location |
| JWT 认证 | JwtAuthFilter | 后端拦截器 |
| 限流 | Redisson | nginx limit_req_zone |
| SSE 支持 | SseFilter | proxy_buffering off |
| CORS | globalcors | nginx add_header |

### 1.3 路由配置

```yaml
routes:
  - auth-route      -> /api/auth/**          -> core-service (无需认证)
  - core-route      -> /api/{user,pet,reminder}/** -> core-service (需认证)
  - core-sse-route  -> /api/reminder/sse/**  -> core-service (需认证+SSE)
  - ai-route        -> /api/ai/document/**   -> ai-service (需认证)
  - ai-sse-route    -> /api/ai/chat/**       -> ai-service (需认证+SSE)
```

---

## 二、改造方案

### 2.1 架构对比

| 维度 | Gateway | Nginx |
|------|---------|-------|
| 路由 | Java 配置 | location 匹配 |
| 认证 | JwtAuthFilter | 后端拦截器 |
| 限流 | Redisson | limit_req_zone |
| SSE | SseFilter | proxy_buffering off |
| 资源消耗 | JVM 内存 (~512MB) | C 内存 (~50MB) |
| 性能 | ~5k qps | ~20k qps |

### 2.2 改动量评估

| 项目 | 改动类型 | 文件数 |
|------|----------|--------|
| 删除模块 | 删除 | 1 个模块 |
| 修改父 POM | 删除 module | 1 处 |
| 新增 Nginx 配置 | 新增 | 1 个文件 |
| 新增 JWT 拦截器 | 新增 | 1 个拦截器 |

**代码改动量：约 80 行（新增 JWT 拦截器）**

### 2.3 JWT 认证方案

由于当前 nginx 未编译 `auth_request` 模块，采用以下方案：

**后端拦截器验证 JWT**

```
请求 -> Nginx -> 后端服务 -> JwtInterceptor -> 验证 JWT -> 业务处理
```

---

## 三、迁移步骤

### 3.1 新增 JWT 拦截器（pet-care-common）

```java
// 文件：modules/pet-care-common/src/main/java/pvt/mktech/petcare/common/interceptor/JwtAuthInterceptor.java
package pvt.mktech.petcare.common.interceptor;

import cn.hutool.core.util.StrUtil;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;
import pvt.mktech.petcare.common.jwt.JwtUtil;

import static pvt.mktech.petcare.common.constant.CommonConstant.*;

/**
 * {@code @description} JWT 认证拦截器，替代 Gateway 的 JwtAuthFilter
 * {@code @date} 2026-01-24
 * {@code @author} Michael
 */
@Component
@RequiredArgsConstructor
public class JwtAuthInterceptor implements HandlerInterceptor {

    private final JwtUtil jwtUtil;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String authHeader = request.getHeader(TOKEN_HEADER);

        if (StrUtil.isBlank(authHeader) || !authHeader.startsWith(TOKEN_PREFIX)) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return false;
        }

        String token = authHeader.substring(TOKEN_PREFIX.length());
        try {
            Claims claims = jwtUtil.parseToken(token);
            Long userId = Long.parseLong(claims.getSubject());
            request.setAttribute(HEADER_USER_ID, userId);
            return true;
        } catch (ExpiredJwtException e) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return false;
        }
    }
}
```

### 3.2 配置拦截器（pet-care-core）

```java
// 文件：modules/pet-care-core/src/main/java/pvt/mktech/petcare/core/config/WebConfig.java
@Configuration
@RequiredArgsConstructor
public class WebConfig implements WebMvcConfigurer {

    private final JwtAuthInterceptor jwtAuthInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtAuthInterceptor)
                .addPathPatterns("/api/user/**", "/api/pet/**", "/api/reminder/**",
                                 "/api/activity/**", "/api/post/**", "/api/label/**")
                .excludePathPatterns("/api/auth/**");
    }
}
```

### 3.3 修改父 POM

删除 gateway 模块引用：
```xml
<modules>
    <module>modules/pet-care-common</module>
    <module>modules/pet-care-core</module>
    <module>modules/pet-care-ai</module>
    <!-- <module>modules/pet-care-gateway</module> -->
</modules>
```

### 3.4 部署 Nginx

将 `nginx.conf` 部署到服务器，重启 Nginx。

---

## 四、风险与注意事项

### 4.1 风险点

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 限流粒度 | Nginx 限流基于 IP，非用户 | 后续可结合 Redis |
| SSE 认证传递 | URL 参数 token 不安全 | 仅开发环境，生产用 Header |

### 4.2 兼容性

- Spring Cloud Gateway 的动态路由特性无法用 Nginx 实现
- 如需动态路由，建议保留 Gateway 或使用 Kong/APISIX

---

## 五、性能对比

| 指标 | Gateway | Nginx |
|------|---------|-------|
| 启动时间 | ~30s | ~1s |
| 内存占用 | ~512MB | ~50MB |
| QPS (单核) | ~5k | ~20k |
| 延迟 (p99) | ~50ms | ~10ms |
